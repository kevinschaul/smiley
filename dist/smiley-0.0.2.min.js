(function(){var e=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){function s(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var a=new this;e=!1;for(var o in i)a[o]="function"==typeof i[o]&&"function"==typeof r[o]&&t.test(i[o])?function(e,t){return function(){var i=this._super;this._super=r[e];var s=t.apply(this,arguments);return this._super=i,s}}(o,i[o]):i[o];return s.prototype=a,s.prototype.constructor=s,s.extend=arguments.callee,s}})();var Display_Module=Class.extend({init:function(e,t){this._smiley=e,this.target_div=t,this.html_template=null,this._hidden=!0},update:function(){var e=this._smiley.dataview.length,t=["<b>",this._smiley.dataview.length,"</b>"," result"],i=1!==e?"s":"";t.push(i),$("#smiley-messages").html(t.join(""))},show:function(){$("#"+this.target_div).show(),this._hidden=!1},hide:function(){$("#"+this.target_div).hide(),this._hidden=!0}}),Table_Display=Display_Module.extend({init:function(e,t){this._super(e,t);var i=this;i._table_template_content=["<tr>"],_.each(i._smiley.config.categories_to_show,function(e){i._table_template_content.push(["<td><%- ",e,"%></td>"].join(""))}),i._table_template_content.push("</tr>"),i.table_template=_.template(i._table_template_content.join(""))},update:function(){this._super();var e=this,t=["<tr>"];_.each(e._smiley.config.categories_to_show,function(e,i){t.push(["<th>",i,"</th>"].join(""))}),t.push("</tr>"),$("#"+e.target_div).html(t.join("")),e._smiley.dataview.each(function(t){$("#"+e.target_div).append(e.table_template(t))})}}),Map_Display=Display_Module.extend({init:function(e,t){var i=this;this._super(e,t);var s={maxZoom:12,scrollWheelZoom:!1};i.map=new L.map(i.target_div,s);var r="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",a={subdomains:["a","b","c"],attribution:'<a href="http://www.openstreetmap.org/copyright">&copy; OpenStreetMap contributors</a> CC-BY-SA'},o=new L.TileLayer(r,a);i.map.addLayer(o)},update:function(){var e=this;if(!e._hidden){e.markersLayer&&e.map.hasLayer(e.markersLayer)&&e.map.removeLayer(e.markersLayer),e.markersLayer=new L.MarkerClusterGroup;var t=!1;e._smiley.dataview.each(function(i){t=!0;var s=i[e._smiley.config.lat_lng];if(s){var r=new L.marker(s.split(",")),a=[];_.each(e._smiley.config.categories_to_show,function(e,t){a.push(["<b>",t,": ","</b>",i[e],"<br />"].join(""))}),r.bindPopup(a.join("")),e.markersLayer.addLayer(r)}}),e.map.addLayer(e.markersLayer),t&&e.map.fitBounds(e.markersLayer.getBounds())}}}),Filter=function(e){this._smiley=e,this._filters={}};Filter.prototype.add_filter=function(e,t){var i=this;i._filters[e]=t},Filter.prototype.remove_filter=function(e){var t=this;delete t._filters[e]},Filter.prototype.reset=function(){var e=this;e._filters={},e._smiley._reset_dataview(),e._smiley.update_displays()},Filter.prototype.reset_control=function(){var e=$(".smiley-select");_.each(e,function(t,i){e[i].selectedIndex=0})},Filter.prototype.perform_filtering=function(){var e=this;e._smiley._reset_dataview(),_.each(e._filters,function(t){e._smiley.dataview=e._filter(t.needle,t.category)}),e._smiley.update_displays()},Filter.prototype._filter=function(e,t){var i=this;return i._smiley.dataview.where({rows:function(i){return _.contains(i[t],e)}})};var Search=function(e){this._smiley=e};Search.prototype.perform_search=function(e){var t=this;t._smiley.dataview=t._search(e),t._smiley.update_displays()},Search.prototype.reset=function(){var e=this;e._smiley._reset_dataview(),e._smiley.update_displays()},Search.prototype.reset_control=function(){$("#smiley-search").val("")},Search.prototype._search=function(e){var t=e.toLowerCase(),i=this;return i._smiley.dataview.where({rows:function(e){var i=!1;return _.each(CONFIG.categories_to_search_by,function(s){if(_.isString(e[s])){var r=e[s];r.toLowerCase().indexOf(t)>=0&&(i=!0)}else{var a=e[s];_.each(a,function(e){e.toLowerCase().indexOf(t)>=0&&(i=!0)})}}),i}})};var Smiley=function(e){var t=this;t.config=e,t.controls_select_template_content=['<select class="smiley-select" id=<%- id %>>','<option value="choose" selected>Choose</option>',"<% _.each(options, function(option) { %>",'<option value="<%- option %>"><%- option %></option>',"<% }); %>","</select>"].join(""),t.controls_select_template=_.template(t.controls_select_template_content),t.ds=new Miso.Dataset({url:t.config.data_url,jsonp:!0,callback:t.config.data_callback,extract:function(e){return t.config.data_subset?e[t.config.data_subset]:e}}),t.dataview=null,t.filter=new Filter(t),t.search=new Search(t),t.display_modules=[],_.each(t.config.views,function(e){switch(e.type){case"table":t.display_modules.push(new Table_Display(t,e.target_div));break;case"map":t.display_modules.push(new Map_Display(t,e.target_div));break;default:}})};Smiley.prototype.go=function(){var e=this;this.ds.fetch({success:function(){e._handle_data(this)},error:function(){console.log("error in ds.fetch()")}})},Smiley.prototype._handle_data=function(){var e=this;e._build_controls(),e._reset_dataview(),e.update_displays()},Smiley.prototype.update_displays=function(){var e=this;_.each(e.display_modules,function(e){e.update()})},Smiley.prototype._build_controls=function(){var e=this;$("#"+e.config.target_div).html(['<div id="smiley-controls"></div>','<div id="smiley-messages"></div>'].join("")),e.config.categories_to_facet_by&&_.each(e.config.categories_to_facet_by,function(t){var i=[],s=e.ds.column(t).data;_.each(s,function(e){_.isArray(e)?_.each(e,function(e){_.contains(i,e)||i.push(e)}):_.contains(i,e)||i.push(e)});var r=_.sortBy(i,function(e){return e}),a="element-"+t;$("#smiley-controls").append(e.controls_select_template({id:a,options:r})),$("#"+a).change(function(){0===this.selectedIndex?e.filter.remove_filter(a):(e.search.reset_control(),e.filter.add_filter(a,{needle:this.value,category:t})),e.filter.perform_filtering()})}),$("#smiley-controls").append('Search <input id="smiley-search" type="text" />'),$("#smiley-controls").append("<input id='reset' type='button' value='Reset'>"),$("#reset").click(function(){e._reset_controls(),e.filter.reset(),e.search.reset()});var t=null;if($("#smiley-search").on($.browser.msie?"propertychange":"input",function(){e.filter.reset_control(),t&&clearTimeout(t),t=setTimeout(function(){var t=$("#smiley-search").val();e.filter.reset(),e.search.perform_search(t),e.update_displays()},250)}),e.config.views){$("#smiley-controls").append("View: "),_.each(e.config.views,function(e,t){$("#smiley-controls").append(['<input type="radio" name="smiley-views" value="',t,'">',e.label].join(""))});var i=$('input[name="smiley-views"]');i.change(function(){e.show_display_module($(this).val()),e._reset_controls(),e._reset_dataview(),e.filter.reset(),e.search.reset()}),$(i[0]).prop("checked",!0),$(i[0]).trigger("change")}},Smiley.prototype.show_display_module=function(e){var t=this;_.each(t.display_modules,function(e){e.hide()}),t.display_modules[e].show()},Smiley.prototype._reset_controls=function(){var e=this;e.filter.reset_control(),e.search.reset_control()},Smiley.prototype._reset_dataview=function(){var e=this;e.dataview=e.ds.where({rows:function(){return!0}}),e.config.sort_by&&e.dataview.sort(function(t,i){var s=e.config.sort_by;return t[s]>i[s]?1:t[s]<i[s]?-1:0})};
(function(){var e=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){function s(){!e&&this.init&&this.init.apply(this,arguments)}var r=this.prototype;e=!0;var a=new this;e=!1;for(var n in i)a[n]="function"==typeof i[n]&&"function"==typeof r[n]&&t.test(i[n])?function(e,t){return function(){var i=this._super;this._super=r[e];var s=t.apply(this,arguments);return this._super=i,s}}(n,i[n]):i[n];return s.prototype=a,s.prototype.constructor=s,s.extend=arguments.callee,s}})();var Display_Module=Class.extend({init:function(e,t,i){this.smiley=e,this.target_div=t,this.view_settings=i,this.html_template=null,this.hidden=!0},update:function(){var e=this.smiley.dataview.length,t=["<b>",this.smiley.dataview.length,"</b>"," result"],i=1!==e?"s":"";t.push(i),$("#smiley-messages").html(t.join(""))},show:function(){$("#"+this.target_div).show(),this.hidden=!1},hide:function(){$("#"+this.target_div).hide(),this.hidden=!0}}),Table_Display=Display_Module.extend({init:function(e,t,i){this._super(e,t,i);var s=this;s.table_template_content=["<tr>"],_.each(s.smiley.config.categories_to_show,function(e){s.table_template_content.push(["<td><%- ",e,"%></td>"].join(""))}),s.table_template_content.push("</tr>"),s.table_template=_.template(s.table_template_content.join(""))},update:function(){this._super();var e=this,t=["<tr>"];_.each(e.smiley.config.categories_to_show,function(e,i){t.push(["<th>",i,"</th>"].join(""))}),t.push("</tr>"),$("#"+e.target_div).html(t.join("")),e.smiley.dataview.each(function(t){$("#"+e.target_div).append(e.table_template(t))})}}),Map_Display=Display_Module.extend({init:function(e,t,i){var s=this;this._super(e,t,i);var r={maxZoom:12,scrollWheelZoom:!1};s.map=new L.map(s.target_div,r);var a="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",n={subdomains:["a","b","c"],attribution:'<a href="http://www.openstreetmap.org/copyright">&copy; OpenStreetMap contributors</a> CC-BY-SA'},o=new L.TileLayer(a,n);s.map.addLayer(o)},update:function(){var e=this;if(!e.hidden){e.markersLayer&&e.map.hasLayer(e.markersLayer)&&e.map.removeLayer(e.markersLayer),e.markersLayer=new L.MarkerClusterGroup;var t=!1;e.smiley.dataview.each(function(i){t=!0;var s=i[e.view_settings.lat_lng];if(s){var r=new L.marker(s.split(",")),a=[];_.each(e.smiley.config.categories_to_show,function(e,t){a.push(["<b>",t,": ","</b>",i[e],"<br />"].join(""))}),e.view_settings.directions_query&&a.push(['<a target="_blank" href="',"https://maps.google.com/?f=d&q=",i[e.view_settings.directions_query],"&near=",i[e.view_settings.lat_lng],'">Get driving directions</a>',"<br />"].join("")),r.bindPopup(a.join("")),e.markersLayer.addLayer(r)}}),e.map.addLayer(e.markersLayer),t&&e.map.fitBounds(e.markersLayer.getBounds())}}}),Filter=function(e){this.smiley=e,this.filters={}};Filter.prototype.add_filter=function(e,t){var i=this;i.filters[e]=t},Filter.prototype.remove_filter=function(e){var t=this;delete t.filters[e]},Filter.prototype.reset=function(){var e=this;e.filters={},e.smiley.reset_dataview(),e.smiley.update_displays()},Filter.prototype.reset_control=function(){var e=$(".smiley-select");_.each(e,function(t,i){e[i].selectedIndex=0})},Filter.prototype.perform_filtering=function(){var e=this;e.smiley.reset_dataview(),_.each(e.filters,function(t){e.smiley.dataview=e.filter(t.needle,t.category)}),e.smiley.update_displays()},Filter.prototype.filter=function(e,t){var i=this;return i.smiley.dataview.where({rows:function(i){return _.contains(i[t],e)}})};var Search=function(e){this.smiley=e};Search.prototype.perform_search=function(e){var t=this;t.smiley.dataview=t.search(e),t.smiley.update_displays()},Search.prototype.reset=function(){var e=this;e.smiley.reset_dataview(),e.smiley.update_displays()},Search.prototype.reset_control=function(){$("#smiley-search").val("")},Search.prototype.search=function(e){var t=e.toLowerCase(),i=this;return i.smiley.dataview.where({rows:function(e){var i=!1;return _.each(CONFIG.categories_to_search_by,function(s){if(_.isString(e[s])){var r=e[s];r.toLowerCase().indexOf(t)>=0&&(i=!0)}else{var a=e[s];_.each(a,function(e){e.toLowerCase().indexOf(t)>=0&&(i=!0)})}}),i}})};var Smiley=function(e){var t=this;t.config=e,t.controls_select_template_content=['<select class="smiley-select" id=<%- id %>>','<option value="choose" selected>Choose</option>',"<% _.each(options, function(option) { %>",'<option value="<%- option %>"><%- option %></option>',"<% }); %>","</select>"].join(""),t.controls_select_template=_.template(t.controls_select_template_content),t.ds=new Miso.Dataset({url:t.config.data_url,jsonp:!0,callback:t.config.data_callback,extract:function(e){return t.config.data_subset?e[t.config.data_subset]:e}}),t.dataview=null,t.filter=new Filter(t),t.search=new Search(t),t.display_modules=[],_.each(t.config.views,function(e){switch(e.type){case"table":t.display_modules.push(new Table_Display(t,e.target_div,e.view_settings));break;case"map":t.display_modules.push(new Map_Display(t,e.target_div,e.view_settings));break;default:}})};Smiley.version="0.0.2",Smiley.prototype.go=function(){var e=this;this.ds.fetch({success:function(){e.handle_data(this)},error:function(){console.log("error in ds.fetch()")}})},Smiley.prototype.handle_data=function(){var e=this;e.build_controls(),e.reset_dataview(),e.update_displays()},Smiley.prototype.update_displays=function(){var e=this;_.each(e.display_modules,function(e){e.update()})},Smiley.prototype.build_controls=function(){var e=this;$("#"+e.config.target_div).html(['<div id="smiley-controls"></div>','<div id="smiley-messages"></div>'].join("")),e.config.categories_to_facet_by&&_.each(e.config.categories_to_facet_by,function(t){if(t){var i=[],s=e.ds.column(t).data;_.each(s,function(e){_.isArray(e)?_.each(e,function(e){_.contains(i,e)||i.push(e)}):_.contains(i,e)||i.push(e)});var r=_.sortBy(i,function(e){return e}),a="element-"+t;$("#smiley-controls").append(e.controls_select_template({id:a,options:r})),$("#"+a).change(function(){0===this.selectedIndex?e.filter.remove_filter(a):(e.search.reset_control(),e.filter.add_filter(a,{needle:this.value,category:t})),e.filter.perform_filtering()})}}),$("#smiley-controls").append('Search <input id="smiley-search" type="text" />'),$("#smiley-controls").append("<input id='reset' type='button' value='Reset'>"),$("#reset").click(function(){e.reset_controls(),e.filter.reset(),e.search.reset()});var t=null;if($("#smiley-search").on($.browser.msie?"keydown":"input",function(){e.filter.reset_control(),t&&clearTimeout(t),t=setTimeout(function(){var t=$("#smiley-search").val();e.filter.reset(),e.search.perform_search(t),e.update_displays()},250)}),e.config.views){$("#smiley-controls").append("View: "),_.each(e.config.views,function(e,t){$("#smiley-controls").append(['<input type="radio" name="smiley-views" value="',t,'">',e.label].join(""))});var i=$('input[name="smiley-views"]');i.change(function(){e.show_display_module($(this).val()),e.reset_controls(),e.reset_dataview(),e.filter.reset(),e.search.reset()}),$(i[0]).prop("checked",!0),$(i[0]).trigger("change")}},Smiley.prototype.show_display_module=function(e){var t=this;_.each(t.display_modules,function(e){e.hide()}),t.display_modules[e].show()},Smiley.prototype.reset_controls=function(){var e=this;e.filter.reset_control(),e.search.reset_control()},Smiley.prototype.reset_dataview=function(){var e=this;e.dataview=e.ds.where({rows:function(){return!0}}),e.config.sort_by&&e.dataview.sort(function(t,i){var s=e.config.sort_by;return t[s]>i[s]?1:t[s]<i[s]?-1:0})};
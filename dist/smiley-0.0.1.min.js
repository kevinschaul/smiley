(function(){var e=!1,t=/xyz/.test(function(){})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(i){function r(){!e&&this.init&&this.init.apply(this,arguments)}var a=this.prototype;e=!0;var s=new this;e=!1;for(var o in i)s[o]="function"==typeof i[o]&&"function"==typeof a[o]&&t.test(i[o])?function(e,t){return function(){var i=this._super;this._super=a[e];var r=t.apply(this,arguments);return this._super=i,r}}(o,i[o]):i[o];return r.prototype=s,r.prototype.constructor=r,r.extend=arguments.callee,r}})();var Display_Module=Class.extend({init:function(e,t){this._smiley=e,this.target_div=t,this.html_template=null},update:function(){var e=this._smiley.dataview.length,t=["<b>",this._smiley.dataview.length,"</b>"," result"],i=1!==e?"s":"";t.push(i),$("#camp-messages").html(t.join(""))}}),Table_Display=Display_Module.extend({init:function(e,t){this._super(e,t);var i=this;i._table_template_content=["<tr>"],_.each(i._smiley.config.categories_to_show,function(e){i._table_template_content.push(["<td><%- ",e,"%></td>"].join(""))}),i._table_template_content.push("</tr>"),i.table_template=_.template(i._table_template_content.join(""))},update:function(){this._super();var e=this,t=["<tr>"];_.each(e._smiley.config.categories_to_show,function(e,i){t.push(["<th>",i,"</th>"].join(""))}),t.push("</tr>"),$("#"+e.target_div).html(t.join("")),e._smiley.dataview.each(function(t){$("#"+e.target_div).append(e.table_template(t))})}}),Map_Display=Display_Module.extend({init:function(e,t){var i=this;this._super(e,t);var r={maxZoom:12,scrollWheelZoom:!1};i.map=new L.map(i.target_div,r);var a="http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",s={subdomains:["a","b","c"],attribution:'<a href="http://www.openstreetmap.org/copyright">&copy; OpenStreetMap contributors</a> CC-BY-SA'},o=new L.TileLayer(a,s);i.map.addLayer(o)},update:function(){var e=this;e.markersLayer&&e.map.hasLayer(e.markersLayer)&&e.map.removeLayer(e.markersLayer),e.markersLayer=new L.MarkerClusterGroup;var t=!1;e._smiley.dataview.each(function(i){t=!0;var r=i[e._smiley.config.lat_lng];if(r){var a=new L.marker(r.split(",")),s=[];_.each(e._smiley.config.categories_to_show,function(e,t){s.push(["<b>",t,": ","</b>",i[e],"<br />"].join(""))}),a.bindPopup(s.join("")),e.markersLayer.addLayer(a)}}),e.map.addLayer(e.markersLayer),t&&e.map.fitBounds(e.markersLayer.getBounds())}}),Filter=function(e){this._smiley=e,this._filters={}};Filter.prototype.add_filter=function(e,t){var i=this;i._filters[e]=t},Filter.prototype.remove_filter=function(e){var t=this;delete t._filters[e]},Filter.prototype.reset=function(){var e=this;e._filters={},e._smiley._reset_dataview(),e._smiley.update_displays()},Filter.prototype.reset_control=function(){var e=$(".smiley-select");_.each(e,function(t,i){e[i].selectedIndex=0})},Filter.prototype.perform_filtering=function(){var e=this;e._smiley._reset_dataview(),_.each(e._filters,function(t){e._smiley.dataview=e._filter(t.needle,t.category)}),e._smiley.update_displays()},Filter.prototype._filter=function(e,t){var i=this;return i._smiley.dataview.where({rows:function(i){return _.contains(i[t],e)}})};var Search=function(e){this._smiley=e};Search.prototype.perform_search=function(e){var t=this;t._smiley.dataview=t._search(e),t._smiley.update_displays()},Search.prototype.reset=function(){var e=this;e._smiley._reset_dataview(),e._smiley.update_displays()},Search.prototype.reset_control=function(){$("#smiley-search").val("")},Search.prototype._search=function(e){var t=e.toLowerCase(),i=this;return i._smiley.dataview.where({rows:function(e){var i=!1;return _.each(CONFIG.categories_to_search_by,function(r){if(_.isString(e[r])){var a=e[r];a.toLowerCase().indexOf(t)>=0&&(i=!0)}else{var s=e[r];_.each(s,function(e){e.toLowerCase().indexOf(t)>=0&&(i=!0)})}}),i}})};var Smiley=function(e){var t=this;t.config=e,t.controls_select_template_content=['<select class="smiley-select" id=<%- id %>>','<option value="choose" selected>Choose</option>',"<% _.each(options, function(option) { %>",'<option value="<%- option %>"><%- option %></option>',"<% }); %>","</select>"].join(""),t.controls_select_template=_.template(t.controls_select_template_content),t.ds=new Miso.Dataset({url:t.config.data_url,jsonp:!0,callback:t.config.data_callback,extract:function(e){return e.items}}),t.dataview=null,t.filter=new Filter(t),t.search=new Search(t),t.display_modules=[],_.each(t.config.views,function(e,i){switch(i){case"table":t.display_modules.push(new Table_Display(t,e));break;case"map":t.display_modules.push(new Map_Display(t,e));break;default:}})};Smiley.prototype.fetch=function(){var e=this;this.ds.fetch({success:function(){e._handle_data(this)},error:function(){console.log("error in ds.fetch()")}})},Smiley.prototype._handle_data=function(){var e=this;e._build_controls(),e._reset_dataview(),e.update_displays()},Smiley.prototype.update_displays=function(){var e=this;_.each(e.display_modules,function(e){e.update()})},Smiley.prototype._build_controls=function(){var e=this;e.config.categories_to_facet_by&&_.each(e.config.categories_to_facet_by,function(t){var i=[],r=e.ds.column(t).data;_.each(r,function(e){_.isArray(e)?_.each(e,function(e){_.contains(i,e)||i.push(e)}):_.contains(i,e)||i.push(e)});var a=_.sortBy(i,function(e){return e}),s="element-"+t;$("#camp-controls").append(e.controls_select_template({id:s,options:a})),$("#"+s).change(function(){console.log(this),0===this.selectedIndex?(console.log("reset"),e.filter.remove_filter(s)):(e.search.reset_control(),e.filter.add_filter(s,{needle:this.value,category:t})),e.filter.perform_filtering()})}),$("#camp-controls").append('Search <input id="smiley-search" type="text" />'),$("#camp-controls").append("<input id='reset' type='button' value='Reset'>"),$("#reset").click(function(){e._reset_controls(),e.filter.reset(),e.search.reset()});var t=null;$("#smiley-search").on("input",function(){e.filter.reset_control(),t&&clearTimeout(t),t=setTimeout(function(){var t=$("#smiley-search").val();e.filter.reset(),e.search.perform_search(t),e.update_displays()},250)})},Smiley.prototype._reset_controls=function(){var e=this;e.filter.reset_control(),e.search.reset_control()},Smiley.prototype._reset_dataview=function(){var e=this;e.dataview=e.ds.where({rows:function(){return!0}})};